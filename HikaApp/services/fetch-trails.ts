/**
 * Bounding boxes for all 50 U.S. States.
 * Format: [south, west, north, east]
 */
export const US_STATE_BBOX = [
  {
    name: "Alabama",
    bbox: [30.223334, -88.473227, 35.008028, -84.88908] as const,
  },
  {
    name: "Arizona",
    bbox: [31.332177, -114.81651, 37.00426, -109.045223] as const,
  },
  {
    name: "Arkansas",
    bbox: [33.004106, -94.617919, 36.4996, -89.644395] as const,
  },
  {
    name: "California",
    bbox: [32.534156, -124.409591, 42.009518, -114.131211] as const,
  },
  {
    name: "Colorado",
    bbox: [36.992426, -109.060253, 41.003444, -102.041524] as const,
  },
  {
    name: "Connecticut",
    bbox: [40.980144, -73.727775, 42.050587, -71.786994] as const,
  },
  {
    name: "Delaware",
    bbox: [38.451013, -75.788658, 39.839007, -75.048939] as const,
  },
  {
    name: "Florida",
    bbox: [24.523096, -87.634938, 31.000888, -80.031362] as const,
  },
  {
    name: "Georgia",
    bbox: [30.357851, -85.605165, 35.000659, -80.839729] as const,
  },
  {
    name: "Hawaii",
    bbox: [18.910361, -178.334698, 28.402123, -154.806773] as const,
  },
  {
    name: "Idaho",
    bbox: [41.988057, -117.243027, 49.001146, -111.043564] as const,
  },
  {
    name: "Illinois",
    bbox: [36.970298, -91.513079, 42.508481, -87.494756] as const,
  },
  {
    name: "Indiana",
    bbox: [37.771742, -88.09776, 41.760592, -84.784579] as const,
  },
  {
    name: "Iowa",
    bbox: [40.375501, -96.639704, 43.501196, -90.140061] as const,
  },
  {
    name: "Kansas",
    bbox: [36.993016, -102.051744, 40.003162, -94.588413] as const,
  },
  {
    name: "Kentucky",
    bbox: [36.497129, -89.571509, 39.147458, -81.964971] as const,
  },
  {
    name: "Louisiana",
    bbox: [28.928609, -94.043147, 33.019457, -88.817017] as const,
  },
  {
    name: "Maine",
    bbox: [42.977764, -71.083924, 47.459686, -66.949895] as const,
  },
  {
    name: "Maryland",
    bbox: [37.911717, -79.487651, 39.723043, -75.048939] as const,
  },
  {
    name: "Massachusetts",
    bbox: [41.237964, -73.508142, 42.886589, -69.928393] as const,
  },
  {
    name: "Michigan",
    bbox: [41.696118, -90.418136, 48.2388, -82.413474] as const,
  },
  {
    name: "Minnesota",
    bbox: [43.499356, -97.239209, 49.384358, -89.491739] as const,
  },
  {
    name: "Mississippi",
    bbox: [30.173943, -91.655009, 34.996052, -88.097888] as const,
  },
  {
    name: "Missouri",
    bbox: [35.995683, -95.774704, 40.61364, -89.098843] as const,
  },
  {
    name: "Montana",
    bbox: [44.358221, -116.050003, 49.00139, -104.039138] as const,
  },
  {
    name: "Nebraska",
    bbox: [39.999998, -104.053514, 43.001708, -95.30829] as const,
  },
  {
    name: "Nevada",
    bbox: [35.001857, -120.005746, 42.002207, -114.039648] as const,
  },
  {
    name: "New Hampshire",
    bbox: [42.69699, -72.557247, 45.305476, -70.610621] as const,
  },
  {
    name: "New Jersey",
    bbox: [38.928519, -75.559614, 41.357423, -73.893979] as const,
  },
  {
    name: "New Mexico",
    bbox: [31.332301, -109.050173, 37.000232, -103.001964] as const,
  },
  {
    name: "New York",
    bbox: [40.496103, -79.762152, 45.01585, -71.856214] as const,
  },
  {
    name: "North Carolina",
    bbox: [33.842316, -84.321869, 36.588117, -75.460621] as const,
  },
  {
    name: "North Dakota",
    bbox: [45.935054, -104.0489, 49.000574, -96.554507] as const,
  },
  {
    name: "Ohio",
    bbox: [38.403202, -84.820159, 41.977523, -80.518693] as const,
  },
  {
    name: "Oklahoma",
    bbox: [33.615833, -103.002565, 37.002206, -94.430662] as const,
  },
  {
    name: "Oregon",
    bbox: [41.991794, -124.566244, 46.292035, -116.463504] as const,
  },
  {
    name: "Pennsylvania",
    bbox: [39.7198, -80.519891, 42.26986, -74.689516] as const,
  },
  {
    name: "Rhode Island",
    bbox: [41.146339, -71.862772, 42.018798, -71.12057] as const,
  },
  {
    name: "South Carolina",
    bbox: [32.0346, -83.35391, 35.215402, -78.54203] as const,
  },
  {
    name: "South Dakota",
    bbox: [42.479635, -104.057698, 45.94545, -96.436589] as const,
  },
  {
    name: "Tennessee",
    bbox: [34.982972, -90.310298, 36.678118, -81.6469] as const,
  },
  {
    name: "Texas",
    bbox: [25.837377, -106.645646, 36.500704, -93.508292] as const,
  },
  {
    name: "Utah",
    bbox: [36.997968, -114.052962, 42.001567, -109.041058] as const,
  },
  {
    name: "Vermont",
    bbox: [42.726853, -73.43774, 45.016659, -71.464555] as const,
  },
  {
    name: "Virginia",
    bbox: [36.540738, -83.675395, 39.466012, -75.242266] as const,
  },
  {
    name: "Washington",
    bbox: [45.543541, -124.763068, 49.002494, -116.915989] as const,
  },
  {
    name: "West Virginia",
    bbox: [37.201483, -82.644739, 40.638801, -77.719519] as const,
  },
  {
    name: "Wisconsin",
    bbox: [42.491983, -92.888114, 47.080621, -86.805415] as const,
  },
  {
    name: "Wyoming",
    bbox: [40.994746, -111.056888, 45.005904, -104.05216] as const,
  },
] as const;

type StateDataType = {
  name: string;
  bbox: readonly [number, number, number, number];
};

// Build the Overpass Query
const buildQuery = (
  south: number,
  west: number,
  north: number,
  east: number
): string => {
  return `
    [out:json][timeout:25];
    (
      relation["route"="hiking"](${south}, ${west}, ${north}, ${east});
      way["highway"="path"]["hiking"="yes"](${south}, ${west}, ${north}, ${east});
    );
    out geom;
  `;
};

const OVERPASS_API_ENDPOINT: string = "https://overpass-api.de/api/interpreter";

/**
 * Main function to fetch and process trail data.
 */
export async function fetchTrailData(stateData: StateDataType): Promise<void> {
  const query: string = buildQuery(...stateData.bbox);

  try {
    const response = await fetch(OVERPASS_API_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `data=${encodeURIComponent(query)}`,
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error(
        "Error from Overpass API: ${response.status} ${response.statusText}"
      );
      console.error(`Server Details: ${errorText}`);
      return;
    }

    const data: any = await response.json();

    console.log(
      `Found ${data.elements.length} elements from ${stateData.name}.`
    );

    // Process Data
    if (data.elements.length > 0) {
      const firstElement = data.elements[0];

      console.log("\nExample of first element:");
      console.log(`Type: ${firstElement.type}`);
      console.log(`ID: ${firstElement.id}`);
      console.log(`Name: ${firstElement.tags.name || "N/A"}`);

      if (firstElement.geometry) {
        console.log(`Geometry points: ${firstElement.geometry.length}`);
      }
    }

    // TODO: Add Firestore saving logic here.
  } catch (error) {
    console.error("An error occurred during the fetch operation:", error);
  }
}

// Define a helper function for the delay
const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// Create an async "main" function to run the loop
export async function processAllStates() {
  console.log(`Processing ${US_STATE_BBOX.length} states...`);

  // Use a 'for...of' loop to go through each state
  for (const stateData of US_STATE_BBOX) {
    try {
      // Use 'await' to wait for this state to finish
      // before moving to the next one.
      await fetchTrailData(stateData);

      // Wait 5 seconds between each state.
      console.log(`--- Finished ${stateData.name}. Waiting 5 seconds... ---`);
      await sleep(5000); // Wait 5 seconds

    } catch (error) {
      console.error(`Failed to process ${stateData.name}:`, error);
    }
  }

  console.log("All states processed!");
}